<%@ page language="java" contentType="text/html; charset=UTF-8" %>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>
<%@ page language="java" contentType="text/html; charset=UTF-8"%>
<%@taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>


<div class="row">

	<!-- 사물함 사용현황 -->
	<div class="col-xl-12">
		<div class="card" id="card-title-1">
			<div class="card-header border-0 pb-0 ">
				<h3>사물함 이용현황</h3>
			</div>
			<div class="card-body d-flex flex-column align-items-center vh-150">
				<div class="col-sm-4" style="margin: 20px 0;">
					<label class="form-label" for="hallCode">건물</label>
					<div class="dropdown bootstrap-select default-select form-control">
						<select name="hallName" class="default-select form-control" id="hallName">
							<option data-display="Select" value="empty">선택해 주세요.</option>
							<c:forEach items="${hallList }" var="hall">
								<option value="${hall.hallCode }" id="hallCode">${hall.hallName }</option>
							</c:forEach>
						</select>
					</div>
				</div>
				<div id="lockerDiv" style="display: none;">
					<ul class="showcase">
						<li>
							<div class="status"></div> <small>사용중</small>
						</li>
						<li>
							<div class="status occupied"></div> <small>사용가능</small>
						</li>
						<li>
							<div class="status selected"></div> <small>선택</small>
						</li>
					</ul>
					<div class="locker-container" id="lockerBox">
						<div class="line"></div>
	
	
	
						<c:forEach items="${lockerList }" var="locker" varStatus="stat">
							<c:if test="${ stat.index % 10 == 0}">
								<div class="locker-row">
							</c:if>
							<%-- <div class="locker occupied"><p>${locker.locNum }</p></div> --%>
							<div class="locker occupied" id="lockerData"
								data-no="${locker.locNum }">
								<p>${stat.count }</p>
							</div>
							<c:if test="${ stat.count % 10 == 0 }">
								</div>
								</c:if>
						</c:forEach>
				</div>

			</div>
		</div>
	</div>
</div>

<!-- 사물함 예약 폼 -->
<div class="col-xl-12">
	<div class="card">
		<div class="card-header">
			<h4 class="card-title">사물함 예약</h4>
		</div>
		<div class="card-body">
			<div class="basic-form">
				
				<form id="lockerForm" action="/locker/lockerReservation" method="post">
					<input type="hidden" id="lockerNum" name="locNum" value=""> 
					<input type="hidden" id="lockerHallCode" name="hallCode" value="">
					<div class="row">
<!-- 						<div class="mb-3 col-md-5"> -->
<!-- 							<label class="col-lg-4 col-form-label" for="validationCustom02">사용자 -->
<!-- 								<span class="text-danger">*</span> -->
<!-- 							</label> <input type="text" class="form-control" placeholder="이름" name="stuName" > -->
<!-- 						</div> -->
						<div class="mb-3 col-md-5">
							<label class="col-lg-4 col-form-label" for="validationCustom02">학번
								<span class="text-danger">*</span>
							</label> <input type="text" class="form-control" placeholder="학번" id="stuId" name="stuId">
						</div>


					</div>
					<div class="row">
						<div class="mb-3 col-md-5">
							<label class="col-lg-4 col-form-label" for="validationCustom02">사용
								시작일 <span class="text-danger">*</span>
							</label> <input type="date" class="form-control" id="lrSdate" name="lrSdate">
						</div>
						<div class="mb-3 col-md-5">
							<label class="col-lg-4 col-form-label" for="validationCustom02">사용
								종료일 <span class="text-danger">*</span>
							</label> <input type="date" class="form-control" id="lrEdate" name="lrEdate">
						</div>
					</div>

					<div
						class="card-footer d-sm-flex justify-content-between align-items-center">
						<div class="card-footer-link mb-4 mb-sm-0">
							<p class="card-text d-inline">번 사물함을 사용하시겠습니까?</p>
						</div>

						<button type="button" class="btn btn-primary" id="alertStart">신청하기</button>
						
					</div>
				</form>
				
			</div>
		</div>
	</div>
</div>





</div>
<!-- row end -->



<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.10/dist/sweetalert2.min.js"></script>
<script>
$(function(){

	var hallCode = "";
	// 사물함 이용현황 - 건물(홀)을 선택할 때 이벤트
	// 건물(홀)을 변경할 때마다 이벤트가 발생한다.
	$("#hallName").on("change", function(){
		// select, 즉 건물을 선택할 때마다 select 내 option 값을 가져온다.
		var code = $(this).val();
		
		// option 값이 empty 인경우엔 "선택해주세요"를 선택한 것이기 때문에 display none으로 가려준다.
		// empty가 아닌 경우엔 해당 건물(홀)을 선택한 것이기 때문에 display block으로 사물함을 예약할 수 있는 폼을 제공한다.
		if(code == "empty"){
			$("#lockerDiv").css("display", "none");	
		}else{
			$("#lockerDiv").css("display", "block");
		}
		
		// 내가 선택한 건물의 코드(키)에 맞는 사물함 정보를 리스트(목록)로 가져온다.
		// 비동기 처리로 해당 목록을 가져오도록 한다.
		
		var data = {
			hallCode : code
		};
		hallCode = code;
		
		$.ajax({
			url : "/locker/getLockerList",
			type: "post",
			data : JSON.stringify(data),
			contentType: "application/json;charset=utf-8",
			dataType : "json",
			success: function(res){
				// selected : 선택 
				// occupied : 사용중
				var html = "";
				html += "<div class='locker-row'>";
				res.map(function(value, idx){
					var status = "occupied";
					if(value.locStatus == "Y"){
						status = "";
					}
					html += "	<div class='locker "+status+"' id='lockerData' data-no='" + value.locNum + "'>";
					html += "		<p>"+(idx+1)+"</p>";
					html += "	</div>";
					if((idx+1) != 0 && (idx+1) % 10 == 0){	// 9 18 27 36 45 
						html += "</div>";
						html += "<div class='locker-row'>";
					}
				});
				html += "</div>";
				
				$("#lockerBox").html(html);
			}
		});
	});
	
	var elementBox = null;
	var flag = true;
	// 사물함 단일 하나씩 선택했을때 이벤트
	$("#lockerBox").on("click", "#lockerData", function(){
		console.log("click...!");
		if(flag){
			$(this).removeClass("occupied");
			$(this).addClass("selected");
			if(elementBox != null){
				elementBox.removeClass("selected");
				elementBox.addClass("occupied");
			}
			elementBox = $(this);	// 방금 누른 사물함
			flag = false;
		}else{
			elementBox.removeClass("selected");
			elementBox.addClass("occupied");
			elementBox = $(this);	// 방금 누른 사물함
			
			$(this).removeClass("occupied");
			$(this).addClass("selected");
			flag = true;
		}
		let lockNum = $(this).data("no");
		console.log(lockNum);
		$("#lockerNum").val(lockNum);	// 내가 선택한 사물함 번호 lockNum을 셋팅
		$("#lockerHallCode").val(hallCode);	// 내가 선택한 사물함의 건물번호인 hallCode를 셋팅
		
	});
	
	var insertForm = document.querySelector("#lockerForm");
	
	// 사물함 예약에서 신청하기 버튼을 클릭했을때
	$("#alertStart").click(function () {
		Swal.fire({
			title : "성공!",
			text : "신청이 완료되었습니다.",
	    	icon  : "success",
	    	closeOnClickOutside : false
		}).then(function(){
			// 이벤트
			insertForm.submit();
		});
	});
	
   

	
});
</script>



